<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steveston ìŠ¤ë§ˆíŠ¸ ì¡°ì„ ì˜ˆë³´</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; width: 95%; max-width: 1000px; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 0.5rem; }
        .date-display { text-align: center; color: #666; font-size: 1.1rem; margin-bottom: 1.5rem; }
        .loading { text-align: center; font-weight: bold; color: #007bff; }
        canvas { width: 100% !important; height: 500px !important; } /* ë†’ì´ë¥¼ ì¡°ê¸ˆ í‚¤ì› ìŠµë‹ˆë‹¤ */
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸŒŠ Steveston (07607) ìƒì„¸ ì¡°ì„ ì˜ˆë³´</h2>
    <div id="dateDisplay" class="date-display">ë‚ ì§œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="loading" class="loading">ë°ì´í„° í†µì‹  ì¤‘...</div>
    <canvas id="tideChart"></canvas>
</div>

<script>
    // Chart.jsì— ë°ì´í„°ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    const today = new Date();
    const startTime = new Date(today.setHours(0,0,0,0)).toISOString();
    const endTime = new Date(today.setHours(23,59,59,999)).toISOString();
    
    document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

    const STATION_CODE = '07607';
    
    async function fetchTideData() {
        try {
            const stationResp = await fetch(`https://api-iwls.dfo-mpo.gc.ca/api/v1/stations?code=${STATION_CODE}`);
            const stationData = await stationResp.json();
            
            if (stationData.length === 0) throw new Error("ê´€ì¸¡ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const stationId = stationData[0].id;

            const dataUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp&from=${startTime}&to=${endTime}`;
            const dataResp = await fetch(dataUrl);
            const tideData = await dataResp.json();

            // ë°ì´í„° ê°€ê³µ ë° Peak/Trough íŒë³„ ë¡œì§
            const plotData = tideData.map((item, index, array) => {
                let pointType = 'normal'; // ê¸°ë³¸ê°’

                // ë°°ì—´ ë²”ìœ„ ì²´í¬ ë° ê³ ì /ì €ì  ì•Œê³ ë¦¬ì¦˜ (Local Maxima/Minima)
                if (index > 0 && index < array.length - 1) {
                    const prev = array[index - 1].value;
                    const curr = item.value;
                    const next = array[index + 1].value;

                    if (curr > prev && curr > next) {
                        pointType = 'high'; // ê³ ì 
                    } else if (curr < prev && curr < next) {
                        pointType = 'low'; // ì €ì 
                    }
                }

                return {
                    x: item.eventDate,
                    y: item.value,
                    type: pointType // ì°¨íŠ¸ ì„¤ì •ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ íƒ€ì… ì €ì¥
                };
            });

            renderChart(plotData);

        } catch (error) {
            console.error(error);
            document.getElementById('loading').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
        }
    }

    function renderChart(data) {
        document.getElementById('loading').style.display = 'none';
        
        const ctx = document.getElementById('tideChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'ì¡°ìœ„ (m)',
                    data: data,
                    borderColor: '#0077be',
                    backgroundColor: 'rgba(0, 119, 190, 0.1)',
                    borderWidth: 2,
                    pointRadius: (ctx) => {
                        // ê³ ì /ì €ì ì¸ ê²½ìš°ì—ë§Œ ì ì„ ì°ìŒ
                        const type = ctx.raw?.type;
                        return (type === 'high' || type === 'low') ? 5 : 0;
                    },
                    pointBackgroundColor: (ctx) => {
                        return ctx.raw?.type === 'high' ? '#ff3b30' : '#007aff'; // ê³ ì  ë¹¨ê°•, ì €ì  íŒŒë‘
                    },
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 30, right: 20, left: 20, bottom: 20 } // ë¼ë²¨ ì˜ë¦¼ ë°©ì§€ ì—¬ë°±
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'ë†’ì´ (m)' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true },
                    
                    // [í•µì‹¬] ë°ì´í„° ë¼ë²¨ í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
                    datalabels: {
                        align: (ctx) => ctx.dataset.data[ctx.dataIndex].type === 'high' ? 'top' : 'bottom',
                        anchor: (ctx) => ctx.dataset.data[ctx.dataIndex].type === 'high' ? 'end' : 'start',
                        offset: 4,
                        color: '#333',
                        font: { weight: 'bold', size: 11 },
                        formatter: (value, ctx) => {
                            // ê³ ì (high)ì´ë‚˜ ì €ì (low)ì¼ ë•Œë§Œ í…ìŠ¤íŠ¸ í‘œì‹œ
                            if (value.type === 'high' || value.type === 'low') {
                                const date = new Date(value.x);
                                const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                                const label = value.type === 'high' ? 'ë§Œì¡°' : 'ê°„ì¡°';
                                return `${label}\n${value.y.toFixed(2)}m\n${timeStr}`;
                            }
                            return null; // ë‚˜ë¨¸ì§€ëŠ” ìˆ¨ê¹€
                        }
                    }
                }
            }
        });
    }

    fetchTideData();
</script>

</body>
</html>
