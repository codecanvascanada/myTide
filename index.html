<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My Tide App</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; }
        .card { background: white; width: 100%; max-width: 800px; padding: 20px 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; box-sizing: border-box; }
        
        /* Search Box */
        .search-container { position: relative; width: 100%; margin: 0 auto 15px auto; z-index: 100; }
        .search-input {
            width: 100%;
            padding: 12px 40px 12px 15px; /* right padding for icon */
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            outline: none;
            box-sizing: border-box; 
            transition: border-color 0.2s;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
        }
        .search-input:focus { border-color: #0077be; }
        
        /* Autocomplete List */
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            list-style: none;
            padding: 0;
            margin: 5px 0 0 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none; 
        }
        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.95rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background-color: #f0f8ff; color: #0077be; } /* ëª¨ë°”ì¼ í„°ì¹˜ê° ê°œì„  */
        .suggestion-code { color: #999; font-size: 0.85em; }

        /* Controls & Display */
        .date-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f8f9fa; padding: 5px; border-radius: 10px; }
        .nav-btn { background-color: #fff; border: 1px solid #eee; border-radius: 8px; width: 44px; height: 44px; cursor: pointer; font-size: 1.2rem; color: #0077be; display: flex; align-items: center; justify-content: center; transition: all 0.1s; -webkit-tap-highlight-color: transparent; }
        .nav-btn:active { background-color: #0077be; color: white; }
        .date-display { font-size: 1rem; font-weight: 600; color: #333; text-align: center; flex-grow: 1; }

        .info-box { background-color: #eef6fc; border: none; color: #0d47a1; padding: 10px; text-align: center; border-radius: 8px; margin-bottom: 10px; font-weight: 600; font-size: 0.95rem; min-height: 1.4em; display: flex; align-items: center; justify-content: center; }
        .loading { text-align: center; font-weight: bold; color: #007bff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        /* [ìˆ˜ì •ë¨] ê·¸ë˜í”„ ë†’ì´ ì¶•ì†Œ (ëª¨ë°”ì¼ í•œ í™”ë©´ì— ë§ì¶¤) */
        canvas { width: 100% !important; height: 350px !important; touch-action: none; } 
    </style>
</head>
<body>

<div class="card">
    <div class="search-container">
        <input type="text" id="stationSearch" class="search-input" placeholder="Search location..." onfocus="prepareStationList()" oninput="filterStations()">
        <ul id="suggestions" class="suggestions-list">
            <li class="suggestion-item" style="cursor: default; color: #999; justify-content: center;">Loading stations...</li>
        </ul>
    </div>
    
    <div class="date-controls">
        <button class="nav-btn" onclick="changeDate(-1)">â—€</button>
        <div id="dateDisplay" class="date-display"></div>
        <button class="nav-btn" onclick="changeDate(1)">â–¶</button>
    </div>

    <div id="currentInfo" class="info-box">Loading...</div>
    <div id="loading" class="loading" style="display: none;"></div>
    <canvas id="tideChart"></canvas>
</div>

<script>
    Chart.register(ChartDataLabels);

    let currentDate = new Date(); 
    let myChart = null; 
    let allStations = []; 
    
    let currentStationCode = localStorage.getItem('tide_station_code') || '07607';
    let currentStationName = localStorage.getItem('tide_station_name') || 'Steveston';

    initApp();

    function initApp() {
        updateDateDisplay();
        document.getElementById('stationSearch').value = currentStationName;
        fetchTideData();
    }

    async function prepareStationList() {
        const list = document.getElementById('suggestions');
        if (allStations.length > 0) {
            filterStations();
            return;
        }
        list.style.display = 'block';
        try {
            const resp = await fetch('https://api-iwls.dfo-mpo.gc.ca/api/v1/stations');
            allStations = await resp.json();
            list.innerHTML = '';
            filterStations(); 
        } catch (e) {
            console.error("Failed to load station list", e);
            list.innerHTML = '<li class="suggestion-item" style="justify-content: center;">Error loading list</li>';
        }
    }

    function filterStations() {
        const input = document.getElementById('stationSearch');
        const list = document.getElementById('suggestions');
        const query = input.value.toLowerCase();

        list.innerHTML = '';
        if (allStations.length === 0) return;

        const matches = allStations
            .filter(s => s.officialName.toLowerCase().includes(query) || s.code.includes(query))
            .slice(0, 10);

        if (matches.length > 0) {
            list.style.display = 'block';
            matches.forEach(s => {
                const li = document.createElement('li');
                li.className = 'suggestion-item';
                li.innerHTML = `<span>${s.officialName}</span> <span class="suggestion-code">${s.code}</span>`;
                li.onclick = () => selectStation(s);
                list.appendChild(li);
            });
        } else {
             const li = document.createElement('li');
             li.className = 'suggestion-item';
             li.style.color = '#999';
             li.style.justifyContent = 'center';
             li.innerText = 'No locations found';
             list.appendChild(li);
             list.style.display = 'block';
        }
    }

    function selectStation(station) {
        currentStationCode = station.code;
        currentStationName = station.officialName;
        localStorage.setItem('tide_station_code', currentStationCode);
        localStorage.setItem('tide_station_name', currentStationName);
        
        document.getElementById('stationSearch').value = currentStationName;
        document.getElementById('suggestions').style.display = 'none';
        fetchTideData();
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) {
            document.getElementById('suggestions').style.display = 'none';
        }
    });

    function changeDate(offset) {
        currentDate.setDate(currentDate.getDate() + offset);
        updateDateDisplay();
        fetchTideData();
    }

    function updateDateDisplay() {
        const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' }; // ëª¨ë°”ì¼ìš© ì§§ì€ ë‚ ì§œ í¬ë§·
        document.getElementById('dateDisplay').innerText = currentDate.toLocaleDateString('en-CA', options);
    }

    const verticalLinePlugin = {
        id: 'verticalLine',
        afterDraw: (chart) => {
            if (chart.tooltip?._active?.length) {
                const ctx = chart.ctx;
                const x = chart.tooltip._active[0].element.x;
                const topY = chart.scales.y.top;
                const bottomY = chart.scales.y.bottom;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, topY);
                ctx.lineTo(x, bottomY);
                ctx.lineWidth = 1.5;
                ctx.strokeStyle = '#ff5722';
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.restore();
            }
        }
    };

    async function fetchTideData() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('currentInfo').innerHTML = `Loading...`;
        
        if (myChart) {
            myChart.destroy();
        }

        const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), 0, 0, 0).toISOString();
        const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), 23, 59, 59).toISOString();

        try {
            let stationId = '';
            const found = allStations.find(s => s.code === currentStationCode);
            if (found) {
                stationId = found.id;
            } else {
                const stationResp = await fetch(`https://api-iwls.dfo-mpo.gc.ca/api/v1/stations?code=${currentStationCode}`);
                const stationData = await stationResp.json();
                if(stationData.length > 0) stationId = stationData[0].id;
                else throw new Error("Station ID not found");
            }

            const curveUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp&from=${startTime}&to=${endTime}`;
            const hiloUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp-hilo&from=${startTime}&to=${endTime}`;

            const [curveResp, hiloResp] = await Promise.all([fetch(curveUrl), fetch(hiloUrl)]);
            const curveData = await curveResp.json();
            const hiloData = await hiloResp.json();

            const lineData = curveData.map(item => ({ x: item.eventDate, y: item.value }));
            const pointData = hiloData.map(item => ({ x: item.eventDate, y: item.value }));

            document.getElementById('currentInfo').innerHTML = "Tap chart for details"; // ëª¨ë°”ì¼ ë¬¸êµ¬ ë³€ê²½
            renderChart(lineData, pointData);

        } catch (error) {
            console.error(error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('currentInfo').innerHTML = "âš ï¸ Data Unavailable";
        }
    }

    function renderChart(lineData, pointData) {
        document.getElementById('loading').style.display = 'none';
        
        const ctx = document.getElementById('tideChart').getContext('2d');
        const infoBox = document.getElementById('currentInfo');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Tide Level',
                        data: lineData,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        hitRadius: 20,
                        fill: true,
                        tension: 0.4,
                        datalabels: { display: false }
                    },
                    {
                        label: 'High/Low',
                        data: pointData,
                        type: 'scatter',
                        backgroundColor: 'red',
                        pointRadius: 5, // ëª¨ë°”ì¼ì—ì„œ ì  í¬ê¸° ì•½ê°„ ì¶•ì†Œ
                        datalabels: {
                            display: true,
                            align: (ctx) => ctx.dataset.data[ctx.dataIndex].y > 2.5 ? 'top' : 'bottom',
                            color: '#333',
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderRadius: 4,
                            padding: 3, // íŒ¨ë”© ì¶•ì†Œ
                            font: { weight: 'bold', size: 11 }, // í°íŠ¸ ì‚¬ì´ì¦ˆ ì¶•ì†Œ
                            formatter: (value) => {
                                const date = new Date(value.x);
                                return `${date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}\n${value.y.toFixed(2)}m`;
                            }
                        }
                    }
                ]
            },
            plugins: [verticalLinePlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                        grid: { display: false },
                        ticks: { maxRotation: 0, autoSkip: true, font: { size: 11 } } // Xì¶• ë¼ë²¨ ê²¹ì¹¨ ë°©ì§€
                    },
                    y: {
                        // [ìˆ˜ì •ë¨] Yì¶• íƒ€ì´í‹€(Height m) ì‚­ì œë¨
                        title: { display: false },
                        ticks: { font: { size: 11 } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { size: 13 },
                        bodyFont: { size: 13 },
                        callbacks: {
                            title: (tooltipItems) => {
                                const date = new Date(tooltipItems[0].raw.x);
                                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                            },
                            label: (tooltipItem) => {
                                const val = tooltipItem.raw.y.toFixed(2);
                                const time = new Date(tooltipItem.raw.x).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                
                                // ëª¨ë°”ì¼ í™”ë©´ì— ë§ê²Œ ì •ë³´ í‘œì‹œì¤„ ê°„ì†Œí™” (ì¥ì†Œ ì´ë¦„ ì œê±°)
                                infoBox.innerHTML = `â±ï¸ ${time} | ğŸ’§ ${val} m`;
                                return `${val} m`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
