<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steveston ì¡°ì„ ì˜ˆë³´ (ë¹¨ê°„ ì  í‘œì‹œ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; width: 95%; max-width: 1000px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 5px; }
        .date-display { text-align: center; color: #666; font-size: 1rem; margin-bottom: 20px; }
        .loading { text-align: center; font-weight: bold; color: #007bff; margin-top: 50px;}
        canvas { width: 100% !important; height: 500px !important; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸŒŠ Steveston (07607) ë¬¼ë•Œí‘œ</h2>
    <div id="dateDisplay" class="date-display">ë‚ ì§œ í™•ì¸ ì¤‘...</div>
    <div id="loading" class="loading">ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <canvas id="tideChart"></canvas>
</div>

<script>
    // í”ŒëŸ¬ê·¸ì¸ ë“±ë¡
    Chart.register(ChartDataLabels);

    const today = new Date();
    // ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ ì˜¤ëŠ˜ 00:00 ~ 23:59 ì„¤ì •
    const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0).toISOString();
    const endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59).toISOString();
    
    document.getElementById('dateDisplay').innerText = today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

    const STATION_CODE = '07607';

    async function fetchTideData() {
        try {
            // 1. ê´€ì¸¡ì†Œ ID ì¡°íšŒ
            const stationResp = await fetch(`https://api-iwls.dfo-mpo.gc.ca/api/v1/stations?code=${STATION_CODE}`);
            const stationData = await stationResp.json();
            const stationId = stationData[0].id;

            // 2. ë°ì´í„° ì¡°íšŒ (wlp: ì˜ˆì¸¡ ë°ì´í„°)
            const dataUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp&from=${startTime}&to=${endTime}`;
            const dataResp = await fetch(dataUrl);
            const tideData = await dataResp.json();

            // 3. ê³ ì (High) / ì €ì (Low) íŒë³„ ë¡œì§
            const plotData = tideData.map((item, index, array) => {
                let pointType = ''; 

                if (index > 0 && index < array.length - 1) {
                    const prev = array[index - 1].value;
                    const curr = item.value;
                    const next = array[index + 1].value;

                    // ì£¼ë³€ë³´ë‹¤ ë†’ìœ¼ë©´ ê³ ì , ë‚®ìœ¼ë©´ ì €ì 
                    if (curr > prev && curr > next) {
                        pointType = 'high'; 
                    } else if (curr < prev && curr < next) {
                        pointType = 'low'; 
                    }
                }

                return {
                    x: item.eventDate,
                    y: item.value,
                    type: pointType // ì°¨íŠ¸ ì„¤ì •ì—ì„œ ì‚¬ìš©
                };
            });

            renderChart(plotData);

        } catch (error) {
            console.error(error);
            document.getElementById('loading').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ (ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”)";
            document.getElementById('loading').style.color = "red";
        }
    }

    function renderChart(data) {
        document.getElementById('loading').style.display = 'none';
        
        const ctx = document.getElementById('tideChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'ì¡°ìœ„ (m)',
                    data: data,
                    borderColor: '#4facfe', // ê·¸ë˜í”„ ì„  ìƒ‰ìƒ (ë°ì€ íŒŒë‘)
                    backgroundColor: 'rgba(79, 172, 254, 0.1)', // ì±„ìš°ê¸° ìƒ‰ìƒ
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4, // ë¶€ë“œëŸ¬ìš´ ê³¡ì„ 
                    
                    // ì  ì„¤ì • (ê¸°ë³¸ì ìœ¼ë¡œëŠ” ìˆ¨ê¸°ê³ , typeì´ ìˆì„ ë•Œë§Œ í‘œì‹œ)
                    pointRadius: (ctx) => (ctx.raw?.type ? 6 : 0), // ì •ì ì€ í¬ê¸° 6, ë‚˜ë¨¸ì§€ëŠ” 0
                    pointBackgroundColor: 'red', // ìš”ì²­í•˜ì‹  "ë¹¨ê°„ ì "
                    pointBorderColor: 'white',
                    pointBorderWidth: 2,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 40, bottom: 20, left: 10, right: 10 } // ê¸€ì”¨ ì˜ë¦¼ ë°©ì§€
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'ë¬¼ ë†’ì´ (m)' },
                        suggestedMax: 4.5 // ê·¸ë˜í”„ ìƒë‹¨ ì—¬ìœ  ê³µê°„ í™•ë³´
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }, // ë§ˆìš°ìŠ¤ ì˜¤ë²„ì‹œ íˆ´íŒ ìœ ì§€
                    
                    // [í…ìŠ¤íŠ¸ í‘œì‹œ ì„¤ì •]
                    datalabels: {
                        display: (ctx) => ctx.dataset.data[ctx.dataIndex].type !== '', // typeì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í‘œì‹œ
                        align: (ctx) => ctx.dataset.data[ctx.dataIndex].type === 'high' ? 'top' : 'bottom', // ê³ ì ì€ ìœ„, ì €ì ì€ ì•„ë˜
                        offset: 8, // ì ê³¼ì˜ ê±°ë¦¬
                        color: '#333', // ê¸€ììƒ‰ (ê²€ì •) - ë¹¨ê°„ì ê³¼ ëŒ€ë¹„ë˜ì–´ ì˜ ë³´ì„
                        backgroundColor: 'rgba(255, 255, 255, 0.8)', // ê¸€ì ë°°ê²½ (ê·¸ë˜í”„ ì„ ê³¼ ê²¹ì¹  ë•Œ ê°€ë…ì„± í™•ë³´)
                        borderRadius: 4,
                        font: { weight: 'bold', size: 12 },
                        formatter: (value) => {
                            const date = new Date(value.x);
                            const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                            // ì˜ˆ: 14:30 \n 3.5m
                            return `${timeStr}\n${value.y.toFixed(2)}m`;
                        },
                        listeners: {
                            // í´ë¦­ ë“±ì˜ ì´ë²¤íŠ¸ í•„ìš” ì‹œ ì¶”ê°€ ê°€ëŠ¥
                        }
                    }
                }
            }
        });
    }

    fetchTideData();
</script>

</body>
</html>
