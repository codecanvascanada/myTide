<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steveston ì¡°ì„ ì˜ˆë³´ (ê³µì‹ ë°ì´í„° ì—°ë™)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; width: 95%; max-width: 1000px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 5px; }
        .date-display { text-align: center; color: #666; font-size: 1rem; margin-bottom: 20px; }
        .loading { text-align: center; font-weight: bold; color: #007bff; margin-top: 50px; }
        canvas { width: 100% !important; height: 500px !important; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸŒŠ Steveston (07607) ë¬¼ë•Œí‘œ</h2>
    <div id="dateDisplay" class="date-display">ë‚ ì§œ í™•ì¸ ì¤‘...</div>
    <div id="loading" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <canvas id="tideChart"></canvas>
</div>

<script>
    Chart.register(ChartDataLabels);

    const today = new Date();
    // UTC ë¬¸ì œ ë°©ì§€ë¥¼ ìœ„í•´ ë„‰ë„‰í•˜ê²Œ í•˜ë£¨ ì „í›„ í¬í•¨í•˜ì—¬ ìš”ì²­ í›„ í•„í„°ë§
    const startTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 0, 0, 0).toISOString();
    const endTime = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59).toISOString();
    
    document.getElementById('dateDisplay').innerText = today.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

    const STATION_CODE = '07607';

    async function fetchTideData() {
        try {
            // 1. ê´€ì¸¡ì†Œ ID ì¡°íšŒ
            const stationResp = await fetch(`https://api-iwls.dfo-mpo.gc.ca/api/v1/stations?code=${STATION_CODE}`);
            const stationData = await stationResp.json();
            const stationId = stationData[0].id;

            // 2. [ê³¡ì„ ìš©] ì „ì²´ ë°ì´í„° ìš”ì²­ (wlp)
            const curveUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp&from=${startTime}&to=${endTime}`;
            
            // 3. [ì /ê¸€ì”¨ìš©] ê³µì‹ ê³ ì¡°/ì €ì¡° ë°ì´í„° ìš”ì²­ (wlp-hilo) -> ì´ê²Œ í•µì‹¬ì…ë‹ˆë‹¤!
            const hiloUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp-hilo&from=${startTime}&to=${endTime}`;

            // ë‘ ë°ì´í„°ë¥¼ ë™ì‹œì— ê°€ì ¸ì˜´
            const [curveResp, hiloResp] = await Promise.all([fetch(curveUrl), fetch(hiloUrl)]);
            const curveData = await curveResp.json();
            const hiloData = await hiloResp.json();

            // ë°ì´í„° í¬ë§·íŒ…
            const lineData = curveData.map(item => ({ x: item.eventDate, y: item.value }));
            
            // ê³ ì /ì €ì  ë°ì´í„° í¬ë§·íŒ… (typeì„ ì§ì ‘ ë„£ì–´ì¤Œ)
            const pointData = hiloData.map(item => ({
                x: item.eventDate,
                y: item.value,
                // ê°’ë§Œìœ¼ë¡œëŠ” ì•Œ ìˆ˜ ì—†ìœ¼ë‹ˆ ì£¼ë³€ ë°ì´í„° ë¡œì§ ëŒ€ì‹  APIê°€ ì¤€ ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                // ë³´í†µ hign/low êµ¬ë¶„ê°’ì´ ì—†ìœ¼ë¯€ë¡œ ë‹¨ìˆœ í‘œì‹œìš©ìœ¼ë¡œ ì”€
                // ë†’ì´ê°€ 2m ì´ìƒì´ë©´ ë§Œì¡°(High), ì´í•˜ë©´ ê°„ì¡°(Low)ë¡œ ì¶”ì •í•˜ê±°ë‚˜ ê·¸ëƒ¥ ë‹¤ ì°ìŒ
                type: 'peak' 
            }));

            renderChart(lineData, pointData);

        } catch (error) {
            console.error(error);
            document.getElementById('loading').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨";
        }
    }

    function renderChart(lineData, pointData) {
        document.getElementById('loading').style.display = 'none';
        
        const ctx = document.getElementById('tideChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    // 1ë²ˆ ë°ì´í„°ì…‹: ë¶€ë“œëŸ¬ìš´ íŒŒë€ ê³¡ì„  (ì  ì—†ìŒ)
                    {
                        label: 'ì¡°ìœ„ ê³¡ì„ ',
                        data: lineData,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0, // ê³¡ì„  ìœ„ì—ëŠ” ì  ì•ˆ ì°ìŒ
                        fill: true,
                        tension: 0.4,
                        datalabels: { display: false } // ê³¡ì„ ì—ëŠ” ê¸€ì”¨ ì•ˆ ì”€
                    },
                    // 2ë²ˆ ë°ì´í„°ì…‹: ë¹¨ê°„ ì ê³¼ ê¸€ì”¨ (High/Low ë°ì´í„°ë§Œ ë³„ë„ë¡œ ì°ìŒ)
                    {
                        label: 'ë§Œì¡°/ê°„ì¡°',
                        data: pointData,
                        type: 'scatter', // ì„  ì—†ì´ ì ë§Œ ì°ëŠ” íƒ€ì…
                        backgroundColor: 'red',
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        datalabels: {
                            display: true, // ë¬´ì¡°ê±´ í‘œì‹œ
                            align: (ctx) => {
                                // yê°’ì´ 2.5ë³´ë‹¤ í¬ë©´ ìœ„ìª½, ì‘ìœ¼ë©´ ì•„ë˜ìª½ì— ê¸€ì”¨ ë°°ì¹˜
                                return ctx.dataset.data[ctx.dataIndex].y > 2.5 ? 'top' : 'bottom';
                            },
                            color: '#333',
                            backgroundColor: 'rgba(255, 255, 255, 0.8)',
                            borderRadius: 4,
                            font: { weight: 'bold', size: 12 },
                            formatter: (value) => {
                                const date = new Date(value.x);
                                const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                                return `${timeStr}\n${value.y.toFixed(2)}m`;
                            }
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 30, bottom: 30 } },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'ë¬¼ ë†’ì´ (m)' },
                        suggestedMin: -0.5,
                        suggestedMax: 5.0
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: true }
                }
            }
        });
    }

    fetchTideData();
</script>

</body>
</html>
