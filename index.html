<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2115172676845444" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Easy Tides - Marine Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; }
        .container { width: 100%; max-width: 800px; display: flex; flex-direction: column; gap: 15px; }
        
        /* --- Í∏∞Ï°¥ Ïπ¥Îìú Ïä§ÌÉÄÏùº --- */
        .card { background: white; width: 100%; padding: 20px 15px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); position: relative; box-sizing: border-box; }
        
        .app-title { text-align: center; margin: 0 0 15px 0; font-size: 1.8rem; font-weight: 800; color: #0d47a1; letter-spacing: -0.5px; }

        .search-container { position: relative; width: 100%; margin: 0 auto 10px auto; z-index: 100; }
        .search-input { width: 100%; padding: 12px 40px 12px 15px; font-size: 1rem; border: 1px solid #ddd; border-radius: 8px; outline: none; box-sizing: border-box; transition: border-color 0.2s; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23999' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 15px center; }
        .search-input:focus { border-color: #0077be; }
        
        .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; max-height: 250px; overflow-y: auto; z-index: 1000; list-style: none; padding: 0; margin: 5px 0 0 0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; }
        .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background-color: #f0f8ff; color: #0077be; }
        .suggestion-code { color: #999; font-size: 0.85em; }

        .date-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f8f9fa; padding: 5px; border-radius: 10px; }
        .nav-btn { background-color: #fff; border: 1px solid #eee; border-radius: 8px; width: 44px; height: 44px; cursor: pointer; font-size: 1.2rem; color: #0077be; display: flex; align-items: center; justify-content: center; transition: all 0.1s; -webkit-tap-highlight-color: transparent; }
        .nav-btn:active { background-color: #0077be; color: white; }
        .date-display { font-size: 1rem; font-weight: 600; color: #333; text-align: center; flex-grow: 1; }

        .info-box { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: none; color: #0d47a1; padding: 12px; text-align: center; border-radius: 12px; margin-bottom: 15px; font-weight: 600; font-size: 0.95rem; min-height: 1.4em; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .info-item { display: inline-flex; align-items: center; gap: 4px; }
        
        .loading { text-align: center; font-weight: bold; color: #007bff; position: absolute; top: 60%; left: 50%; transform: translate(-50%, -50%); }
        
        /* [ÏàòÏ†ïÎê®] ÎÜíÏù¥Î•º 400pxÎ°ú ÎäòÎ¶º */
        canvas { width: 100% !important; height: 400px !important; touch-action: none; } 

        /* --- NEW SECTIONS STYLES --- */
        .section-title { font-size: 1.1rem; font-weight: 700; color: #333; margin-bottom: 12px; border-left: 4px solid #0077be; padding-left: 10px; }
        
        .weather-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .stat-icon { font-size: 1.8rem; margin-bottom: 5px; }
        .stat-value { font-size: 1.1rem; font-weight: 700; color: #333; }
        .stat-label { font-size: 0.8rem; color: #666; margin-top: 2px; }

        .wind-compass { position: relative; width: 60px; height: 60px; border: 2px solid #ddd; border-radius: 50%; margin-bottom: 5px; display: flex; align-items: center; justify-content: center; }
        .wind-arrow { font-size: 1.5rem; color: #ff5722; transform-origin: center; display: inline-block; }
        
        .weekly-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .weekly-table th { text-align: left; padding: 10px; color: #666; font-weight: 600; border-bottom: 2px solid #eee; }
        .weekly-table td { padding: 12px 10px; border-bottom: 1px solid #f0f0f0; color: #333; }
        .weekly-table tr:last-child td { border-bottom: none; }
        .tide-tag { padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
        .tag-high { background-color: #e3f2fd; color: #1976d2; }
        .tag-low { background-color: #fff3e0; color: #f57c00; }

        .marine-note { background-color: #e8f5e9; color: #2e7d32; padding: 12px; border-radius: 8px; font-size: 0.9rem; line-height: 1.4; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1 class="app-title">Easy Tides</h1>

        <div class="search-container">
            <input type="text" id="stationSearch" class="search-input" placeholder="Search location..." onfocus="prepareStationList()" oninput="filterStations()">
            <ul id="suggestions" class="suggestions-list"><li class="suggestion-item" style="justify-content: center; color: #999;">Loading...</li></ul>
        </div>
        
        <div id="currentInfo" class="info-box">
            Touch graph for details
        </div>

        <div class="date-controls">
            <button class="nav-btn" onclick="changeDate(-1)">‚óÄ</button>
            <div id="dateDisplay" class="date-display"></div>
            <button class="nav-btn" onclick="changeDate(1)">‚ñ∂</button>
        </div>

        <div id="loading" class="loading" style="display: none;"></div>
        <canvas id="tideChart"></canvas>
    </div>

    <div class="card">
        <div class="section-title">Current Conditions</div>
        <div class="weather-grid">
            <div class="stat-card">
                <div class="wind-compass">
                    <div id="windArrow" class="wind-arrow">‚Üë</div>
                </div>
                <div id="windText" class="stat-value">-- km/h</div>
                <div id="windDirText" class="stat-label">Direction</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚òÄÔ∏è</div>
                <div id="sunTimes" class="stat-value">--:--</div>
                <div class="stat-label">Sunrise / Sunset</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üå°Ô∏è</div>
                <div id="tempText" class="stat-value">--¬∞C</div>
                <div class="stat-label">Temperature</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚òî</div>
                <div id="rainText" class="stat-value">-- mm</div>
                <div class="stat-label">Precipitation</div>
            </div>
        </div>
        <div id="sailingNote" class="marine-note">
            Loading marine conditions...
        </div>
    </div>

    <div class="card">
        <div class="section-title">7-Day Tide Forecast</div>
        <table class="weekly-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Hi/Lo</th>
                    <th>Time</th>
                    <th>Height</th>
                </tr>
            </thead>
            <tbody id="weeklyTideBody">
                <tr><td colspan="4" style="text-align: center;">Loading forecast...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    Chart.register(ChartDataLabels);

    let currentDate = new Date(); 
    let myChart = null; 
    let allStations = []; 
    let hourlyWeatherData = []; 
    
    let currentStationCode = localStorage.getItem('tide_station_code') || '07607';
    let currentStationName = localStorage.getItem('tide_station_name') || 'Steveston';

    initApp();

    function initApp() {
        updateDateDisplay();
        document.getElementById('stationSearch').value = currentStationName;
        fetchTideData(); 
    }

    async function fetchWeatherData(lat, lon, dateObj) {
        try {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,wind_speed_10m,weather_code&daily=sunrise,sunset,precipitation_sum&current_weather=true&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`;
            
            const resp = await fetch(url);
            const data = await resp.json();
            
            if (data.hourly) {
                hourlyWeatherData = data.hourly.time.map((t, i) => ({
                    time: t, 
                    temp: data.hourly.temperature_2m[i],
                    wind: data.hourly.wind_speed_10m[i],
                    code: data.hourly.weather_code[i]
                }));
            } else {
                hourlyWeatherData = [];
            }

            updateDashboard(data);

        } catch (e) {
            console.error("Weather load failed", e);
            hourlyWeatherData = [];
        }
    }

    function updateDashboard(data) {
        if (!data || !data.current_weather || !data.daily) return;

        const current = data.current_weather;
        const daily = data.daily;

        // Wind
        const windSpeed = current.windspeed;
        const windDir = current.winddirection;
        document.getElementById('windArrow').style.transform = `rotate(${windDir + 180}deg)`; 
        document.getElementById('windText').innerText = `${windSpeed} km/h`;
        document.getElementById('windDirText').innerText = getCardinalDirection(windDir);

        // Sun
        const sunrise = new Date(daily.sunrise[0]).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        const sunset = new Date(daily.sunset[0]).toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
        document.getElementById('sunTimes').innerHTML = `‚¨Ü ${sunrise}<br>‚¨á ${sunset}`;

        // Temp & Rain
        document.getElementById('tempText').innerText = `${current.temperature}¬∞C`;
        document.getElementById('rainText').innerText = `${daily.precipitation_sum[0]} mm`;

        // Marine Note
        const noteEl = document.getElementById('sailingNote');
        if (windSpeed < 10) {
            noteEl.innerText = "üçÉ Calm winds. Excellent for motor cruising or kayaking. Sailing might be slow.";
            noteEl.style.backgroundColor = "#e8f5e9"; noteEl.style.color = "#2e7d32";
        } else if (windSpeed < 25) {
            noteEl.innerText = "‚õµ Good sailing breeze! Moderate conditions suitable for most recreational craft.";
            noteEl.style.backgroundColor = "#e3f2fd"; noteEl.style.color = "#0d47a1";
        } else {
            noteEl.innerText = "‚ö†Ô∏è Strong winds detected. Choppy waters expected. Exercise caution.";
            noteEl.style.backgroundColor = "#ffebee"; noteEl.style.color = "#c62828";
        }
    }

    function getCardinalDirection(angle) {
        const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
        return directions[Math.round(angle / 45) % 8];
    }

    async function fetchWeeklyTides(stationId) {
        const tableBody = document.getElementById('weeklyTideBody');
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center">Loading forecast...</td></tr>';

        const startDate = new Date();
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + 6); 

        const fromStr = startDate.toISOString();
        const toStr = endDate.toISOString();

        try {
            const url = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp-hilo&from=${fromStr}&to=${toStr}`;
            const resp = await fetch(url);
            const data = await resp.json();

            tableBody.innerHTML = '';
            
            let currentDayStr = '';
            
            data.forEach(item => {
                const dateObj = new Date(item.eventDate);
                const dayStr = dateObj.toLocaleDateString('en-GB', {weekday: 'short', month: 'short', day: 'numeric'});
                const timeStr = dateObj.toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'});
                
                const row = document.createElement('tr');
                
                const dateCell = (dayStr !== currentDayStr) ? `<strong>${dayStr}</strong>` : '';
                currentDayStr = dayStr;

                const tagClass = item.value > 3.0 ? 'tag-high' : (item.value < 2.0 ? 'tag-low' : '');
                const typeText = item.value > 3.0 ? 'High' : (item.value < 2.0 ? 'Low' : '-');

                row.innerHTML = `
                    <td>${dateCell}</td>
                    <td><span class="tide-tag ${tagClass}">${typeText}</span></td>
                    <td>${timeStr}</td>
                    <td>${item.value.toFixed(2)}m</td>
                `;
                tableBody.appendChild(row);
            });

        } catch (e) {
            tableBody.innerHTML = '<tr><td colspan="4">Forecast unavailable</td></tr>';
        }
    }

    function getWeatherCategory(code) {
        if (code === 0) return 'clear';
        if (code >= 1 && code <= 3) return 'cloud';
        if (code >= 45 && code <= 48) return 'fog';
        if (code >= 51 && code <= 67) return 'rain'; 
        if (code >= 71 && code <= 77) return 'snow';
        if (code >= 80 && code <= 82) return 'rain'; 
        if (code >= 85 && code <= 86) return 'snow';
        if (code >= 95) return 'storm';
        return 'unknown';
    }

    function getWeatherIcon(code) {
        if (code === 0) return '‚òÄÔ∏è'; 
        if (code >= 1 && code <= 3) return '‚õÖ'; 
        if (code >= 45 && code <= 48) return 'üå´Ô∏è'; 
        if (code >= 51 && code <= 67) return 'üåßÔ∏è'; 
        if (code >= 71 && code <= 77) return '‚ùÑÔ∏è'; 
        if (code >= 80 && code <= 82) return 'üå¶Ô∏è'; 
        if (code >= 95) return '‚õàÔ∏è'; 
        return '‚òÅÔ∏è';
    }

    async function prepareStationList() {
        const list = document.getElementById('suggestions');
        if (allStations.length > 0) { filterStations(); return; }
        list.style.display = 'block';
        try {
            const resp = await fetch('https://api-iwls.dfo-mpo.gc.ca/api/v1/stations');
            allStations = await resp.json();
            list.innerHTML = ''; filterStations(); 
        } catch (e) { list.innerHTML = '<li class="suggestion-item">Error loading list</li>'; }
    }

    function filterStations() {
        const input = document.getElementById('stationSearch');
        const list = document.getElementById('suggestions');
        const query = input.value.toLowerCase();
        list.innerHTML = '';
        if (allStations.length === 0) return;
        const matches = allStations.filter(s => s.officialName.toLowerCase().includes(query) || s.code.includes(query)).slice(0, 10);
        if (matches.length > 0) {
            list.style.display = 'block';
            matches.forEach(s => {
                const li = document.createElement('li');
                li.className = 'suggestion-item';
                li.innerHTML = `<span>${s.officialName}</span> <span class="suggestion-code">${s.code}</span>`;
                li.onclick = () => selectStation(s);
                list.appendChild(li);
            });
        } else {
             const li = document.createElement('li');
             li.className = 'suggestion-item'; li.style.color = '#999'; li.style.justifyContent = 'center'; li.innerText = 'No locations found';
             list.appendChild(li); list.style.display = 'block';
        }
    }

    function selectStation(station) {
        currentStationCode = station.code;
        currentStationName = station.officialName;
        localStorage.setItem('tide_station_code', currentStationCode);
        localStorage.setItem('tide_station_name', currentStationName);
        document.getElementById('stationSearch').value = currentStationName;
        document.getElementById('suggestions').style.display = 'none';
        fetchTideData();
    }

    document.addEventListener('click', function(e) {
        if (!e.target.closest('.search-container')) document.getElementById('suggestions').style.display = 'none';
    });

    function changeDate(offset) {
        currentDate.setDate(currentDate.getDate() + offset);
        updateDateDisplay();
        fetchTideData();
    }

    function updateDateDisplay() {
        const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'short' };
        document.getElementById('dateDisplay').innerText = currentDate.toLocaleDateString('en-CA', options);
    }

    async function fetchTideData() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('currentInfo').innerHTML = `Loading ${currentStationName}...`;
        
        if (myChart) myChart.destroy();

        const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), 0, 0, 0).toISOString();
        const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), 23, 59, 59).toISOString();

        try {
            let stationObj = null;
            const found = allStations.find(s => s.code === currentStationCode);
            if (found) stationObj = found;
            else {
                const stationResp = await fetch(`https://api-iwls.dfo-mpo.gc.ca/api/v1/stations?code=${currentStationCode}`);
                const stationData = await stationResp.json();
                if(stationData.length > 0) stationObj = stationData[0];
                else throw new Error("Station not found");
            }

            if (stationObj.latitude && stationObj.longitude) {
                await fetchWeatherData(stationObj.latitude, stationObj.longitude, currentDate);
            }

            fetchWeeklyTides(stationObj.id);

            const curveUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationObj.id}/data?time-series-code=wlp&from=${startTime}&to=${endTime}`;
            const hiloUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationObj.id}/data?time-series-code=wlp-hilo&from=${startTime}&to=${endTime}`;

            const [curveResp, hiloResp] = await Promise.all([fetch(curveUrl), fetch(hiloUrl)]);
            const curveData = await curveResp.json();
            const hiloData = await hiloResp.json();

            const lineData = curveData.map(item => ({ x: item.eventDate, y: item.value }));
            const pointData = hiloData.map(item => ({ x: item.eventDate, y: item.value }));

            document.getElementById('currentInfo').innerHTML = "Tap/Hover chart for details";
            renderChart(lineData, pointData);

        } catch (error) {
            console.error(error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('currentInfo').innerHTML = "‚ö†Ô∏è Data Unavailable";
        }
    }

    const currentTimePlugin = {
        id: 'currentTime',
        afterDraw: (chart) => {
            const now = new Date();
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            const xPos = xAxis.getPixelForValue(now.getTime());

            if (xPos >= xAxis.left && xPos <= xAxis.right) {
                const dataset = chart.data.datasets[0].data;
                let yValue = null;
                const nowTime = now.getTime();

                for (let i = 0; i < dataset.length - 1; i++) {
                    const p1 = dataset[i];
                    const p2 = dataset[i+1];
                    const t1 = new Date(p1.x).getTime();
                    const t2 = new Date(p2.x).getTime();

                    if (nowTime >= t1 && nowTime <= t2) {
                        const ratio = (nowTime - t1) / (t2 - t1);
                        yValue = p1.y + (p2.y - p1.y) * ratio;
                        break;
                    }
                }

                if (yValue !== null) {
                    const yPos = yAxis.getPixelForValue(yValue);
                    ctx.save();
                    ctx.beginPath();
                    ctx.moveTo(xPos, yAxis.top);
                    ctx.lineTo(xPos, yAxis.bottom);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = '#2196F3';
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.arc(xPos, yPos, 4, 0, 2 * Math.PI);
                    ctx.fillStyle = '#2196F3';
                    ctx.fill();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    const timeStr = now.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
                    const heightStr = yValue.toFixed(2) + 'm';

                    const padding = 4;
                    const borderRadius = 4;
                    const fontSize = 11;
                    ctx.font = `bold ${fontSize}px Arial`;
                    
                    const textWidth1 = ctx.measureText(timeStr).width;
                    const textWidth2 = ctx.measureText(heightStr).width;
                    const boxWidth = Math.max(textWidth1, textWidth2) + (padding * 2);
                    const boxHeight = (fontSize * 2) + (padding * 2) + 2; 
                    
                    let boxY = yPos - boxHeight - 8; 
                    if (boxY < yAxis.top) boxY = yPos + 8; 

                    const boxX = xPos - (boxWidth / 2);

                    ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                    ctx.beginPath();
                    ctx.roundRect(boxX, boxY, boxWidth, boxHeight, borderRadius);
                    ctx.fill();
                    
                    ctx.fillStyle = '#0d47a1'; 
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'top';
                    ctx.fillText(timeStr, xPos, boxY + padding);
                    ctx.fillText(heightStr, xPos, boxY + padding + fontSize + 2);

                    ctx.restore();
                }
            }
        }
    };

    const weatherIconPlugin = {
        id: 'weatherIcons',
        afterDraw: (chart) => {
            if (hourlyWeatherData.length === 0) return;
            
            const ctx = chart.ctx;
            const xAxis = chart.scales.x;
            const yAxis = chart.scales.y;
            
            ctx.save();
            ctx.textAlign = 'center';
            ctx.font = '10px Arial';
            
            let previousCategory = null; 

            for (let i = 0; i < 24; i++) {
                if (!hourlyWeatherData[i]) continue;
                
                const currentCode = hourlyWeatherData[i].code;
                const currentCategory = getWeatherCategory(currentCode);

                if (previousCategory === null || currentCategory !== previousCategory) {
                    
                    const d = new Date(currentDate);
                    d.setHours(i, 0, 0, 0);
                    const xPos = xAxis.getPixelForValue(d.getTime());
                    
                    if (xPos >= xAxis.left && xPos <= xAxis.right) {
                        const icon = getWeatherIcon(currentCode);
                        ctx.fillText(icon, xPos, yAxis.bottom + 50); 
                    }
                    previousCategory = currentCategory;
                }
            }
            ctx.restore();
        }
    };

    const verticalLinePlugin = {
        id: 'verticalLine',
        afterDraw: (chart) => {
            if (chart.tooltip?._active?.length) {
                const ctx = chart.ctx;
                const x = chart.tooltip._active[0].element.x;
                const topY = chart.scales.y.top;
                const bottomY = chart.scales.y.bottom;
                ctx.save();
                ctx.beginPath(); ctx.moveTo(x, topY); ctx.lineTo(x, bottomY);
                ctx.lineWidth = 1.5; ctx.strokeStyle = '#ff5722'; ctx.setLineDash([5, 5]);
                ctx.stroke(); ctx.restore();
            }
        }
    };

    function renderChart(lineData, pointData) {
        document.getElementById('loading').style.display = 'none';
        const ctx = document.getElementById('tideChart').getContext('2d');
        const infoBox = document.getElementById('currentInfo');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Tide Level', data: lineData,
                        borderColor: '#4facfe', backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2, pointRadius: 0, hitRadius: 20, fill: true, tension: 0.4,
                        datalabels: { display: false }
                    },
                    {
                        label: 'High/Low', data: pointData, type: 'scatter',
                        backgroundColor: 'red', pointRadius: 5,
                        datalabels: {
                            display: true,
                            align: (ctx) => ctx.dataset.data[ctx.dataIndex].y > 2.5 ? 'top' : 'bottom',
                            color: '#333', backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderRadius: 4, padding: 3, font: { weight: 'bold', size: 11 },
                            formatter: (value) => {
                                const date = new Date(value.x);
                                return `${date.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}\n${value.y.toFixed(2)}m`;
                            }
                        }
                    }
                ]
            },
            plugins: [verticalLinePlugin, weatherIconPlugin, currentTimePlugin],
            options: {
                responsive: true, maintainAspectRatio: false,
                layout: {
                    padding: { bottom: 60 }
                },
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { 
                        type: 'time', 
                        time: { unit: 'hour', displayFormats: { hour: 'H' } }, 
                        grid: { display: false }, 
                        ticks: { maxRotation: 0, autoSkip: true, font: { size: 12 } } 
                    },
                    y: { title: { display: false }, ticks: { font: { size: 11 } } }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: false, 
                        external: (context) => {
                            const tooltipModel = context.tooltip;
                            if (tooltipModel.opacity === 0) return;

                            const dataPoint = tooltipModel.dataPoints[0];
                            const timeMs = dataPoint.parsed.x;
                            const tideVal = dataPoint.parsed.y.toFixed(2);
                            
                            const date = new Date(timeMs);
                            const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                            const hour = date.getHours();

                            let weatherStr = "";
                            if (hourlyWeatherData[hour]) {
                                const w = hourlyWeatherData[hour];
                                const icon = getWeatherIcon(w.code);
                                weatherStr = `<span class="info-item">${icon} ${w.temp}¬∞C</span> <span class="info-item">üå¨Ô∏è ${w.wind} km/h</span>`;
                            }

                            infoBox.innerHTML = `
                                <span class="info-item">‚è±Ô∏è ${timeStr}</span>
                                <span class="info-item">üíß ${tideVal}m</span>
                                ${weatherStr}
                            `;
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
