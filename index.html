<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steveston ì‹¤ì‹œê°„ ì¡°ì„ ì˜ˆë³´</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; width: 90%; max-width: 900px; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 0.5rem; }
        .date-display { text-align: center; color: #666; font-size: 1.1rem; margin-bottom: 1.5rem; }
        .loading { text-align: center; font-weight: bold; color: #007bff; }
        canvas { width: 100% !important; height: 400px !important; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸŒŠ Steveston (07607) ì¡°ì„ ê·¸ë˜í”„</h2>
    <div id="dateDisplay" class="date-display">ë‚ ì§œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="loading" class="loading">ë°ì´í„° í†µì‹  ì¤‘...</div>
    <canvas id="tideChart"></canvas>
</div>

<script>
    // 1. ë‚ ì§œ ì„¤ì • (ì˜¤ëŠ˜ ì‹œì‘ ~ ì˜¤ëŠ˜ ë)
    const today = new Date();
    const startTime = new Date(today.setHours(0,0,0,0)).toISOString();
    const endTime = new Date(today.setHours(23,59,59,999)).toISOString();
    
    // í™”ë©´ì— ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
    document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });

    // 2. API ì„¤ì •
    // Steveston ê´€ì¸¡ì†Œ ì½”ë“œ: 07607 -> ë‚´ë¶€ ID ì¡°íšŒë¥¼ ìœ„í•´ ë¨¼ì € ê²€ìƒ‰í•˜ê±°ë‚˜, IDë¥¼ ì•Œë©´ ë°”ë¡œ í˜¸ì¶œ ê°€ëŠ¥
    // Steveston(07607)ì˜ ê³ ìœ  IDëŠ” ë³´í†µ ê³ ì •ë˜ì–´ ìˆìœ¼ë‚˜, ì•ˆì „í•˜ê²Œ ì½”ë“œë¡œ ê²€ìƒ‰ ë¡œì§ì„ í¬í•¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // ì—¬ê¸°ì„œëŠ” API êµ¬ì¡°ìƒ 07607 ì½”ë“œë¥¼ ì´ìš©í•´ ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.
    
    // ìºë‚˜ë‹¤ DFO ê³µì‹ API ì—”ë“œí¬ì¸íŠ¸
    const STATION_CODE = '07607';
    
    async function fetchTideData() {
        try {
            // A. ìŠ¤í…Œì´ì…˜ ID ì°¾ê¸°
            const stationResp = await fetch(`https://api-iwls.dfo-mpo.gc.ca/api/v1/stations?code=${STATION_CODE}`);
            const stationData = await stationResp.json();
            
            if (stationData.length === 0) throw new Error("ê´€ì¸¡ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const stationId = stationData[0].id; // ë‚´ë¶€ UUID ì¶”ì¶œ

            // B. í•´ë‹¹ ìŠ¤í…Œì´ì…˜ì˜ ì˜¤ëŠ˜ ë‚ ì§œ ì˜ˆë³´ ë°ì´í„°(wlp: Water Level Prediction) ê°€ì ¸ì˜¤ê¸°
            const dataUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp&from=${startTime}&to=${endTime}`;
            const dataResp = await fetch(dataUrl);
            const tideData = await dataResp.json();

            // C. ë°ì´í„° ê°€ê³µ (Chart.js í¬ë§·ìœ¼ë¡œ ë³€í™˜)
            const plotData = tideData.map(item => ({
                x: item.eventDate, // ISO String (ìë™ìœ¼ë¡œ ë¡œì»¬ ì‹œê°„ëŒ€ ë³€í™˜ë¨)
                y: item.value      // ë†’ì´ (m)
            }));

            renderChart(plotData);

        } catch (error) {
            console.error(error);
            document.getElementById('loading').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ì½˜ì†” í™•ì¸ í•„ìš”)";
            document.getElementById('loading').style.color = "red";
        }
    }

    function renderChart(data) {
        document.getElementById('loading').style.display = 'none';
        
        const ctx = document.getElementById('tideChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'ì˜ˆìƒ ì¡°ìœ„ (m)',
                    data: data,
                    borderColor: '#0077be',
                    backgroundColor: 'rgba(0, 119, 190, 0.2)',
                    borderWidth: 2,
                    pointRadius: 0, // ì  ìˆ¨ê¹€ (ë§¤ë„ëŸ¬ìš´ ì„ )
                    pointHoverRadius: 6,
                    fill: true,
                    tension: 0.4 // ê³¡ì„ 
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time', // ì‹œê°„ ì¶• ì„¤ì •
                        time: {
                            unit: 'hour',
                            displayFormats: { hour: 'HH:mm' },
                            tooltipFormat: 'HH:mm'
                        },
                        title: { display: true, text: 'ì‹œê°„' }
                    },
                    y: {
                        title: { display: true, text: 'ë†’ì´ (ë¯¸í„°)' }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `ë†’ì´: ${context.parsed.y}m`;
                            }
                        }
                    }
                }
            }
        });
    }

    fetchTideData();
</script>

</body>
</html>
