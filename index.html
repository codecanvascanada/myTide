<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BCì£¼ í†µí•© ì¡°ì„ ì˜ˆë³´</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f6f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; width: 95%; max-width: 1000px; padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* í—¤ë” ì˜ì—­ (ì œëª© + ê´€ì¸¡ì†Œ ì„ íƒ) */
        .header-container { text-align: center; margin-bottom: 20px; }
        h2 { margin: 0 0 10px 0; color: #333; font-size: 1.5rem; }
        
        /* ê´€ì¸¡ì†Œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìŠ¤íƒ€ì¼ */
        select {
            padding: 8px 12px;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: #f8f9fa;
            cursor: pointer;
            outline: none;
            font-weight: bold;
            color: #444;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        select:hover { border-color: #0077be; }

        /* ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ */
        .date-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .nav-btn {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 1.1rem;
            color: #555;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn:hover { background-color: #0077be; color: white; border-color: #0077be; }
        .date-display { font-size: 1.1rem; font-weight: 600; color: #333; min-width: 180px; text-align: center; }

        /* ì •ë³´ ë°•ìŠ¤ */
        .info-box {
            background-color: #eef6fc;
            border: 1px solid #d0e7f9;
            color: #0d47a1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 1.1em;
            min-height: 1.5em; 
        }
        .loading { text-align: center; font-weight: bold; color: #007bff; margin-top: 50px; }
        canvas { width: 100% !important; height: 500px !important; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-container">
        <select id="stationSelect" onchange="changeStation()">
            <option value="07607" selected>ğŸ“ Steveston (ìŠ¤í‹°ë¸ŒìŠ¤í†¤)</option>
            <option value="07590">ğŸ“ Sand Heads (ìƒŒë“œ í—¤ì¦ˆ)</option>
            <option value="07654">ğŸ“ New Westminster (ë‰´ ì›¨ìŠ¤íŠ¸ë¯¼ìŠ¤í„°)</option>
            <option value="07795">ğŸ“ Point Atkinson (ì›¨ìŠ¤íŠ¸ ë°´ì¿ ë²„)</option>
            <option value="07735">ğŸ“ Vancouver (ë°´ì¿ ë²„ í•­êµ¬)</option>
            <option value="07120">ğŸ“ Victoria (ë¹…í† ë¦¬ì•„)</option>
            <option value="07905">ğŸ“ Nanaimo (ë‚˜ë‚˜ì´ëª¨)</option>
            <option value="07535">ğŸ“ Tsawwassen (íŠ¸ì™€ìŠ¨)</option>
            <option value="07490">ğŸ“ White Rock (í™”ì´íŠ¸ ë½)</option>
        </select>
    </div>
    
    <div class="date-controls">
        <button class="nav-btn" onclick="changeDate(-1)">â—€</button>
        <div id="dateDisplay" class="date-display"></div>
        <button class="nav-btn" onclick="changeDate(1)">â–¶</button>
    </div>

    <div id="currentInfo" class="info-box">ê·¸ë˜í”„ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ë³´ì„¸ìš”</div>

    <div id="loading" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <canvas id="tideChart"></canvas>
</div>

<script>
    Chart.register(ChartDataLabels);

    // ì „ì—­ ë³€ìˆ˜
    let currentDate = new Date(); 
    let myChart = null; 
    let currentStationCode = '07607'; // ê¸°ë³¸ê°’: Steveston
    let currentStationName = 'Steveston';

    // ì´ˆê¸° ì‹¤í–‰
    updateDateDisplay();
    fetchTideData();

    // 1. ê´€ì¸¡ì†Œ ë³€ê²½ í•¨ìˆ˜
    function changeStation() {
        const select = document.getElementById('stationSelect');
        currentStationCode = select.value;
        currentStationName = select.options[select.selectedIndex].text;
        
        // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
        fetchTideData();
    }

    // 2. ë‚ ì§œ ë³€ê²½ í•¨ìˆ˜
    function changeDate(offset) {
        currentDate.setDate(currentDate.getDate() + offset);
        updateDateDisplay();
        fetchTideData();
    }

    function updateDateDisplay() {
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('dateDisplay').innerText = currentDate.toLocaleDateString('ko-KR', options);
    }

    // 3. ì»¤ìŠ¤í…€ í”ŒëŸ¬ê·¸ì¸: ì„¸ë¡œ ê°€ì´ë“œë¼ì¸ (Crosshair)
    const verticalLinePlugin = {
        id: 'verticalLine',
        afterDraw: (chart) => {
            if (chart.tooltip?._active?.length) {
                const ctx = chart.ctx;
                const x = chart.tooltip._active[0].element.x;
                const topY = chart.scales.y.top;
                const bottomY = chart.scales.y.bottom;
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x, topY);
                ctx.lineTo(x, bottomY);
                ctx.lineWidth = 1.5;
                ctx.strokeStyle = '#ff5722';
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.restore();
            }
        }
    };

    async function fetchTideData() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('currentInfo').innerHTML = `${currentStationName} ë°ì´í„° ë¡œë”© ì¤‘...`;
        
        if (myChart) {
            myChart.destroy();
        }

        const startTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), 0, 0, 0).toISOString();
        const endTime = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), 23, 59, 59).toISOString();

        try {
            // A. ì„ íƒëœ ê´€ì¸¡ì†Œ ì½”ë“œ(currentStationCode)ë¡œ ID ì¡°íšŒ
            const stationResp = await fetch(`https://api-iwls.dfo-mpo.gc.ca/api/v1/stations?code=${currentStationCode}`);
            const stationData = await stationResp.json();
            
            if (!stationData || stationData.length === 0) {
                throw new Error("ê´€ì¸¡ì†Œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            const stationId = stationData[0].id;

            // B. ë°ì´í„° ìš”ì²­ (ê³¡ì„ ìš© wlp, ê³ ì €ì ìš© wlp-hilo)
            const curveUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp&from=${startTime}&to=${endTime}`;
            const hiloUrl = `https://api-iwls.dfo-mpo.gc.ca/api/v1/stations/${stationId}/data?time-series-code=wlp-hilo&from=${startTime}&to=${endTime}`;

            const [curveResp, hiloResp] = await Promise.all([fetch(curveUrl), fetch(hiloUrl)]);
            const curveData = await curveResp.json();
            const hiloData = await hiloResp.json();

            const lineData = curveData.map(item => ({ x: item.eventDate, y: item.value }));
            const pointData = hiloData.map(item => ({ x: item.eventDate, y: item.value }));

            document.getElementById('currentInfo').innerHTML = "ê·¸ë˜í”„ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ë³´ì„¸ìš”";
            renderChart(lineData, pointData);

        } catch (error) {
            console.error(error);
            document.getElementById('loading').innerText = "ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + error.message;
            document.getElementById('currentInfo').innerHTML = "âš ï¸ ë°ì´í„° í†µì‹  ì˜¤ë¥˜";
        }
    }

    function renderChart(lineData, pointData) {
        document.getElementById('loading').style.display = 'none';
        
        const ctx = document.getElementById('tideChart').getContext('2d');
        const infoBox = document.getElementById('currentInfo');

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'ì¡°ìœ„ ê³¡ì„ ',
                        data: lineData,
                        borderColor: '#4facfe',
                        backgroundColor: 'rgba(79, 172, 254, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        hitRadius: 20,
                        fill: true,
                        tension: 0.4,
                        datalabels: { display: false }
                    },
                    {
                        label: 'ë§Œì¡°/ê°„ì¡°',
                        data: pointData,
                        type: 'scatter',
                        backgroundColor: 'red',
                        pointRadius: 6,
                        datalabels: {
                            display: true,
                            align: (ctx) => ctx.dataset.data[ctx.dataIndex].y > 2.5 ? 'top' : 'bottom',
                            color: '#333',
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            borderRadius: 4,
                            padding: 4,
                            font: { weight: 'bold', size: 12 },
                            formatter: (value) => {
                                const date = new Date(value.x);
                                return `${date.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit', hour12:false})}\n${value.y.toFixed(2)}m`;
                            }
                        }
                    }
                ]
            },
            plugins: [verticalLinePlugin],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm' } },
                        grid: { display: false }
                    },
                    y: {
                        title: { display: true, text: 'ë¬¼ ë†’ì´ (m)' }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        callbacks: {
                            title: (tooltipItems) => {
                                const date = new Date(tooltipItems[0].raw.x);
                                return date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                            },
                            label: (tooltipItem) => {
                                const val = tooltipItem.raw.y.toFixed(2);
                                const time = new Date(tooltipItem.raw.x).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false });
                                
                                // ìƒë‹¨ ì •ë³´ ë°•ìŠ¤ ì—…ë°ì´íŠ¸ (ë‚ ì§œ + ì¥ì†Œ + ì‹œê°„ + ë†’ì´)
                                infoBox.innerHTML = `ğŸ“ ${currentStationName} | â±ï¸ ${time} | ğŸ’§ ${val} m`;
                                return `${val} m`;
                            }
                        }
                    }
                }
            }
        });
    }
</script>

</body>
</html>
